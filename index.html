<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hamza TV Ultra</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f0f0f">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HCNJRN7GQ6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-HCNJRN7GQ6');
    </script>

    <style>
        /* (Ù†ÙØ³ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠØ©) */
        :root { --primary: #e50914; --bg: #0f0f0f; --card: #1f1f1f; --text: #fff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: 'Tajawal', sans-serif; margin: 0; padding-bottom: 100px; overflow-x: hidden; }
        header { position: sticky; top: 0; z-index: 50; padding: 15px; background: rgba(15,15,15,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #333; }
        .search-wrapper { position: relative; width: 100%; max-width: 600px; margin: 0 auto; }
        .search-inp { width: 100%; background: #222; border: none; padding: 12px 45px 12px 20px; border-radius: 50px; color: white; font-family: inherit; font-size: 16px; transition: 0.3s; }
        .search-inp:focus { background: #333; box-shadow: 0 0 0 2px var(--primary); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #777; }
        .cats { display: flex; gap: 10px; overflow-x: auto; padding: 15px; scrollbar-width: none; }
        .cats::-webkit-scrollbar { display: none; }
        .chip { background: #252525; padding: 8px 18px; border-radius: 20px; white-space: nowrap; font-size: 14px; cursor: pointer; transition: 0.3s; border: 1px solid transparent; color: #aaa; }
        .chip.active { background: var(--primary); color: white; font-weight: bold; border-color: var(--primary); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 12px; padding: 15px; }
        .card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 130px; position: relative; transition: 0.3s; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .card img { width: 55px; height: 55px; object-fit: contain; border-radius: 50%; background: #fff; padding: 4px; margin-bottom: 10px; }
        .card h3 { font-size: 12px; text-align: center; margin: 0; color: #ddd; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .fav-btn { position: absolute; top: 8px; right: 8px; font-size: 18px; color: rgba(255,255,255,0.3); z-index: 2; }
        .fav-btn.active { color: var(--primary); transform: scale(1.2); }
        .player-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 1000; display: none; flex-direction: column; justify-content: center; }
        video { width: 100%; max-height: 100vh; }
        .close-player { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2); color: white; padding: 8px 15px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; z-index: 1001; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #333; color: white; padding: 12px 25px; border-radius: 30px; transition: 0.4s; opacity: 0; z-index: 2000; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #source-count { position: absolute; top: 20px; right: 20px; color: #aaa; font-size: 12px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 10px; z-index: 1002; }
    </style>
</head>
<body>

    <header>
        <div class="search-wrapper">
            <span class="search-icon">ğŸ”</span>
            <input type="text" class="search-inp" id="search" placeholder="Ø§Ø¨Ø­Ø«..." onkeyup="filter()">
        </div>
    </header>

    <div class="cats">
        <div class="chip active" onclick="setCat('all', this)">Ø§Ù„ÙƒÙ„</div>
        <div class="chip" onclick="setCat('fav', this)">â¤ï¸ Ø§Ù„Ù…ÙØ¶Ù„Ø©</div>
        <div class="chip" onclick="setCat('news', this)">ğŸ“° Ø£Ø®Ø¨Ø§Ø±</div>
        <div class="chip" onclick="setCat('movies', this)">ğŸ¬ Ø£ÙÙ„Ø§Ù…</div>
        <div class="chip" onclick="setCat('kids', this)">ğŸˆ Ø£Ø·ÙØ§Ù„</div>
        <div class="chip" onclick="setCat('sports', this)">âš½ Ø±ÙŠØ§Ø¶Ø©</div>
    </div>

    <div class="grid" id="grid"></div>
    <div style="text-align:center; margin-top:50px; color:#555" id="loader">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

    <div class="player-modal" id="modal">
        <div id="source-count"></div>
        <button class="close-player" onclick="closeVideo()">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
        <video id="video" controls playsinline></video>
    </div>

    <div class="toast" id="toast"><span id="toast-msg"></span></div>

    <script>
        let allData = [];
        let favs = JSON.parse(localStorage.getItem('favs_v3')) || [];
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        fetch('channels.json?' + Date.now()).then(r => r.json()).then(d => {
            allData = d;
            document.getElementById('loader').style.display = 'none';
            render(allData);
        });

        function render(list) {
            const grid = document.getElementById('grid');
            grid.innerHTML = "";
            list.slice(0, 200).forEach(ch => { // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 200 Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø£Ø¯Ø§Ø¡
                let isFav = favs.includes(ch.name);
                let logo = ch.logo || "https://cdn-icons-png.flaticon.com/512/2503/2503508.png";
                // Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ù„Ù„Ù‚Ù†Ø§Ø©
                let sourceBadge = ch.urls.length > 1 ? `<span style="position:absolute; bottom:5px; right:5px; background:#e50914; color:white; font-size:10px; padding:2px 6px; border-radius:10px;">${ch.urls.length} Ù…ØµØ§Ø¯Ø±</span>` : '';

                let el = document.createElement('div');
                el.className = 'card';
                el.innerHTML = `
                    <div class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFav('${ch.name}', event)">â™¥</div>
                    <img src="${logo}" loading="lazy" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2503/2503508.png'">
                    <h3>${ch.name}</h3>
                    ${sourceBadge}
                `;
                el.onclick = (e) => { if(!e.target.classList.contains('fav-btn')) startSmartPlayer(ch); };
                grid.appendChild(el);
            });
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø°ÙƒÙŠ (Failover System) ---
        let hls = null;
        function startSmartPlayer(ch) {
            const modal = document.getElementById('modal');
            const video = document.getElementById('video');
            const counter = document.getElementById('source-count');
            
            modal.style.display = 'flex';
            let urls = ch.urls; // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
            let currentIdx = 0;

            function tryPlay() {
                if(currentIdx >= urls.length) {
                    alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø¬Ù…ÙŠØ¹ Ø±ÙˆØ§Ø¨Ø· Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ù†Ø§Ø© Ù…ØªÙˆÙ‚ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹.");
                    closeVideo();
                    return;
                }
                
                let url = urls[currentIdx];
                counter.innerText = `Ø§Ù„Ù…ØµØ¯Ø±: ${currentIdx + 1} / ${urls.length}`;
                console.log("Trying source:", url);

                if (Hls.isSupported()) {
                    if(hls) hls.destroy();
                    hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                    
                    // Ø§Ù„Ø³Ø­Ø± Ù‡Ù†Ø§: Ø¥Ø°Ø§ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ
                    hls.on(Hls.Events.ERROR, function (event, data) {
                        if (data.fatal) {
                            console.log("Source failed, trying next...");
                            currentIdx++;
                            tryPlay();
                        }
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = url;
                    video.play();
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø®Ø·Ø§Ø¡ Ø³ÙØ§Ø±ÙŠ
                    video.onerror = () => {
                        currentIdx++;
                        tryPlay();
                    };
                }
            }

            tryPlay(); // Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
        }

        function closeVideo() {
            document.getElementById('modal').style.display = 'none';
            let v = document.getElementById('video');
            v.pause();
            v.src = "";
            if(hls) hls.destroy();
        }

        // Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Ù…ÙØ¶Ù„Ø©ØŒ Ø¨Ø­Ø«ØŒ ØªØµÙ†ÙŠÙØ§Øª)
        function toggleFav(name, e) {
            e.stopPropagation();
            if(favs.includes(name)) favs = favs.filter(n => n !== name);
            else favs.push(name);
            localStorage.setItem('favs_v3', JSON.stringify(favs));
            render(allData); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø¨Ø³ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ù„ÙˆØ¨
            showToast(favs.includes(name) ? "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©" : "ØªÙ… Ø§Ù„Ø­Ø°Ù");
        }

        function setCat(cat, btn) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            let res = (cat === 'all') ? allData : (cat === 'fav') ? allData.filter(x => favs.includes(x.name)) : allData.filter(x => x.category === cat);
            render(res);
        }

        function filter() {
            let q = document.getElementById('search').value.toLowerCase();
            render(allData.filter(x => x.name.toLowerCase().includes(q)));
        }

        function showToast(msg) {
            let t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate TV Pro ğŸ“º</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- Video.js & HLS -->
    <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet" />
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #e50914;
            --bg: #141414;
            --surface: #1f1f1f;
            --text-main: #fff;
            --text-sec: #b3b3b3;
            --success: #46d369;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Player Wrapper --- */
        .player-wrapper {
            position: relative;
            background: #000;
            width: 100%;
            max-height: 85vh; 
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            overflow: hidden;
        }

        @media (min-width: 1024px) {
            .player-wrapper {
                max-width: 1100px;
                margin: 20px auto;
                border-radius: 12px;
                border: 1px solid #333;
            }
        }

        .video-js { width: 100%; height: 100%; font-family: 'Tajawal', sans-serif; }
        .video-js.vjs-fluid { height: 0 !important; padding-top: 56.25%; }
        
        .video-js .vjs-big-play-button {
            background-color: var(--primary) !important;
            border: none;
            width: 80px; height: 80px; line-height: 80px;
            border-radius: 50%;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            backdrop-filter: blur(5px);
        }

        #brightness-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; opacity: 0; pointer-events: none; z-index: 50;
            transition: opacity 0.1s;
        }

        .gesture-hud {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); padding: 15px 25px; border-radius: 10px;
            font-size: 1.5rem; color: white; display: none; z-index: 60;
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1);
        }

        .controls-panel {
            background: #181818; border-bottom: 1px solid #333;
            padding: 15px; max-width: 1100px; margin: 0 auto;
        }

        .channel-header {
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 10px;
        }

        .current-channel-info { display: flex; flex-direction: column; }
        .current-channel-name { font-weight: 800; font-size: 1.2rem; }
        .current-channel-status { font-size: 0.8rem; color: var(--success); display: flex; align-items: center; gap: 5px; }

        .player-actions { display: flex; gap: 10px; }
        .action-btn {
            background: #333; border: none; color: white; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .action-btn:hover { background: #444; }
        .action-btn.share { background: #2563eb; }

        /* Navigation */
        .nav-container { max-width: 1100px; margin: 0 auto; padding: 10px 15px; }
        .category-scroll {
            display: flex; gap: 10px; overflow-x: auto;
            padding-bottom: 10px; scrollbar-width: none;
        }
        .category-scroll::-webkit-scrollbar { display: none; }

        .cat-tag {
            background: #2a2a2a; padding: 8px 18px; border-radius: 50px;
            font-size: 0.9rem; cursor: pointer; white-space: nowrap;
            border: 1px solid #333; transition: 0.3s;
        }
        .cat-tag.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }
        .cat-tag.special { color: #ffd700; border-color: #ffd700; }
        .cat-tag.special.active { background: #ffd700; color: black; }

        .search-container { margin-top: 10px; }
        .search-input {
            width: 100%; padding: 12px 15px; border-radius: 8px;
            border: 1px solid #333; background: #252525; color: white;
            font-family: inherit; font-size: 1rem;
        }

        /* Grid */
        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px; padding: 15px; max-width: 1100px; margin: 0 auto;
            padding-bottom: 80px;
        }

        .card {
            background: var(--surface); border-radius: 12px; padding: 15px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            cursor: pointer; transition: all 0.2s; position: relative; height: 150px;
            border: 1px solid #333;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); background: #252525; }
        
        .card img {
            width: 60px; height: 60px; object-fit: contain; margin-bottom: 10px;
            pointer-events: none; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
            background: rgba(255,255,255,0.05); border-radius: 50%; padding: 5px;
        }

        .card-title {
            font-size: 0.85rem; font-weight: 600; line-height: 1.3;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }

        .fav-heart {
            position: absolute; top: 8px; left: 8px; font-size: 1.2rem;
            color: #444; transition: 0.2s; z-index: 5; padding: 5px;
        }
        .fav-heart:hover, .fav-heart.active { color: var(--primary); }

        .system-msg {
            grid-column: 1 / -1; text-align: center; padding: 40px;
            color: #777; background: #1a1a1a; border-radius: 10px; border: 1px dashed #333;
        }
        
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.95); color: white; padding: 12px 24px;
            border-radius: 30px; font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            display: flex; align-items: center; gap: 10px; opacity: 0; visibility: hidden;
            transition: 0.3s; z-index: 2000; border: 1px solid #333;
        }
        .toast.show { opacity: 1; visibility: visible; bottom: 50px; }

        .server-selector {
            display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; scrollbar-width: none;
        }
        .server-btn {
            background: #333; color: white; border: 1px solid #444; padding: 5px 15px;
            border-radius: 4px; cursor: pointer; font-size: 0.8rem; white-space: nowrap;
        }
        .server-btn:hover { background: var(--primary); border-color: var(--primary); }

        .touch-area-left, .touch-area-right {
            position: absolute; top: 0; height: 100%; width: 40%; z-index: 20;
        }
        .touch-area-left { left: 0; }
        .touch-area-right { right: 0; }
    </style>
</head>
<body>

    <!-- 1. Ø§Ù„Ù…Ø´ØºÙ„ -->
    <div class="player-wrapper">
        <div id="brightness-overlay"></div>
        <div id="gesture-feedback" class="gesture-hud"></div>
        <div class="touch-area-left" id="touch-left"></div>
        <div class="touch-area-right" id="touch-right"></div>
        <video id="tv-player" class="video-js vjs-default-skin vjs-big-play-centered" controls muted playsinline preload="none" poster="https://wallpapers.com/images/hd/netflix-background-gs7hjuwvv2g0e9fj.jpg" data-setup='{"liveui": true, "fluid": true}'></video>
    </div>

    <!-- 2. Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="controls-panel">
        <div class="channel-header">
            <div class="current-channel-info">
                <div id="channel-name" class="current-channel-name">Ultimate TV Pro</div>
                <div class="current-channel-status"><i class="fas fa-satellite-dish"></i> <span id="status-text">Ø§Ù†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</span></div>
            </div>
            <div class="player-actions">
                <button class="action-btn" onclick="togglePiP()" title="PiP"><i class="fas fa-images"></i> PiP</button>
                <button class="action-btn" onclick="setSleepTimer()" title="Timer"><i class="fas fa-stopwatch"></i> Ù…Ø¤Ù‚Øª</button>
                <button class="action-btn share" onclick="shareChannel()" title="Share"><i class="fas fa-share-alt"></i></button>
            </div>
        </div>
        <div id="server-list" class="server-selector" style="display:none;"></div>
    </div>

    <!-- 3. Ø§Ù„ØªÙ†Ù‚Ù„ -->
    <div class="nav-container">
        <div class="category-scroll">
            <div class="cat-tag active" onclick="filterBy('all', this)">Ø§Ù„ÙƒÙ„ ğŸŒ</div>
            <div class="cat-tag special" onclick="filterBy('fav', this)"><i class="fas fa-heart"></i> Ø§Ù„Ù…ÙØ¶Ù„Ø©</div>
            <div class="cat-tag" onclick="filterBy('sports', this)">âš½ Ø±ÙŠØ§Ø¶Ø©</div>
            <div class="cat-tag" onclick="filterBy('movies', this)">ğŸ¬ Ø£ÙÙ„Ø§Ù…</div>
            <div class="cat-tag" onclick="filterBy('news', this)">ğŸ“° Ø£Ø®Ø¨Ø§Ø±</div>
            <div class="cat-tag" onclick="filterBy('kids', this)">ğŸ§¸ Ø£Ø·ÙØ§Ù„</div>
            <div class="cat-tag" onclick="filterBy('religious', this)">ğŸ•Œ Ø¥Ø³Ù„Ø§Ù…ÙŠ</div>
        </div>
        <div class="search-container">
            <input type="text" id="search-box" class="search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ù†Ø§Ø© (Ù…Ø«Ø§Ù„: MBC, Bein)..." onkeyup="handleSearch()">
        </div>
    </div>

    <!-- 4. Ø§Ù„Ø´Ø¨ÙƒØ© -->
    <div id="channels-grid" class="grid-container">
        <div class="system-msg"><i class="fas fa-spinner fa-spin fa-2x"></i><br>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©...</div>
    </div>

    <div id="toast" class="toast"><i class="fas fa-check"></i> <span id="toast-msg">ØªÙ…</span></div>

    <script src="https://vjs.zencdn.net/7.20.3/video.js"></script>
    <script>
        const player = videojs('tv-player');
        let allChannels = [];
        let favorites = JSON.parse(localStorage.getItem('ultimateFavs')) || [];
        let currentChannel = null;
        let brightnessLevel = 1;

        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedName = urlParams.get('ch');

            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„Ù
                const jsonUrl = 'channels.json?t=' + Date.now();
                const response = await fetch(jsonUrl);
                
                if (!response.ok) throw new Error("File not found");
                
                allChannels = await response.json();
                renderChannels(allChannels);
                showToast(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allChannels.length} Ù‚Ù†Ø§Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸš€`, true);

                if(sharedName) {
                    const decoded = decodeURIComponent(sharedName);
                    const ch = allChannels.find(c => c.name === decoded);
                    if(ch) playChannel(ch);
                }
            } catch (err) {
                console.error("Error loading channels:", err);
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø·Ø£ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Preview) Ø­ÙŠØ« Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¬Ø§ÙˆØ±Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©
                if(err.message.includes('Failed to parse URL') || location.protocol === 'blob:') {
                     allChannels = [
                        {name: "Ù‚Ù†Ø§Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© (Preview)", logo: "https://via.placeholder.com/100?text=Demo", category: "general", urls: ["https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8"]},
                        {name: "MBC 1 (Demo)", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/MBC_1_Logo.svg/512px-MBC_1_Logo.svg.png", category: "general", urls: ["https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8"]}
                    ];
                    renderChannels(allChannels);
                    showToast('ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©: ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© âš ï¸', true);
                    document.getElementById('channels-grid').insertAdjacentHTML('afterbegin', '<div style="grid-column:1/-1;text-align:center;color:#ffd700;margin-bottom:10px;border:1px dashed #ffd700;padding:10px;">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø£Ù†Øª ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Preview). Ù„ÙƒÙŠ ØªØ¸Ù‡Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ ÙŠØ¬Ø¨ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¹Ù„Ù‰ GitHub.</div>');
                } else {
                    document.getElementById('channels-grid').innerHTML = 
                        '<div class="system-msg" style="color:#e50914">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ù‚Ù†ÙˆØ§Øª (channels.json). ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† (update.py).</div>';
                }
            }
            setupGestures();
            setupShortcuts();
        };

        function renderChannels(list) {
            const grid = document.getElementById('channels-grid');
            grid.innerHTML = '';
            
            if (!list || list.length === 0) {
                grid.innerHTML = '<div class="system-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div>';
                return;
            }

            const limit = Math.min(list.length, 250);
            for (let i = 0; i < limit; i++) {
                const ch = list[i];
                const card = document.createElement('div');
                card.className = 'card';
                const isFav = favorites.includes(ch.name);
                const logo = ch.logo && ch.logo.length > 5 ? ch.logo : 'https://cdn-icons-png.flaticon.com/512/2503/2503508.png';
                
                card.innerHTML = `
                    <i class="fas fa-heart fav-heart ${isFav ? 'active' : ''}" onclick="toggleFav(event, '${ch.name.replace(/'/g, "\\'")}')"></i>
                    <img src="${logo}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2503/2503508.png'" loading="lazy">
                    <div class="card-title">${ch.name}</div>
                    ${ch.urls.length > 1 ? '<span style="font-size:10px; color:#46d369; margin-top:5px;">â— Ø³ÙŠØ±ÙØ±Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©</span>' : ''}
                `;
                card.onclick = (e) => { if(!e.target.classList.contains('fav-heart')) playChannel(ch); };
                grid.appendChild(card);
            }
        }

        function playChannel(ch) {
            currentChannel = ch;
            document.getElementById('channel-name').innerText = ch.name;
            const status = document.getElementById('status-text');
            status.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...'; status.style.color = '#fff';

            renderServers(ch);
            playStream(ch.urls[0]);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function playStream(url) {
            // ÙƒØ´Ù Ù…Ø´ÙƒÙ„Ø© Mixed Content
            if (location.protocol === 'https:' && url.startsWith('http:')) {
                showToast('âš ï¸ Ø§Ù„Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø´ÙØ±Ø© (HTTP) Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ø§Ø¨ØªÙˆØ¨', true);
            }
            player.src({ src: url, type: 'application/x-mpegURL' });
            player.play().catch(e => console.log("Auto-play prevented"));
        }

        function renderServers(ch) {
            const container = document.getElementById('server-list');
            if(ch.urls.length > 1) {
                container.style.display = 'flex';
                container.innerHTML = ch.urls.map((url, i) => 
                    `<button class="server-btn" onclick="playStream('${url}')">Ø³ÙŠØ±ÙØ± ${i+1}</button>`
                ).join('');
            } else { container.style.display = 'none'; }
        }

        player.on('playing', () => {
            const s = document.getElementById('status-text'); s.innerText = 'Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± ğŸ”´'; s.style.color = 'var(--success)';
        });
        player.on('error', () => {
            const s = document.getElementById('status-text'); s.innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ¯Ø± âš ï¸'; s.style.color = 'red';
        });

        // Gestures & Shortcuts
        function setupGestures() {
            let startY=0, startVol=1, startBright=1;
            const hud = document.getElementById('gesture-feedback');

            const left = document.getElementById('touch-left');
            left.addEventListener('touchstart', e => { startY=e.touches[0].clientY; startBright=brightnessLevel; });
            left.addEventListener('touchmove', e => {
                e.preventDefault(); const d = startY - e.touches[0].clientY;
                brightnessLevel = Math.min(1, Math.max(0.2, startBright + (d/300)));
                document.getElementById('brightness-overlay').style.opacity = 1 - brightnessLevel;
                showHud(`<i class="fas fa-sun"></i> ${Math.round(brightnessLevel*100)}%`);
            });

            const right = document.getElementById('touch-right');
            right.addEventListener('touchstart', e => { startY=e.touches[0].clientY; startVol=player.volume(); });
            right.addEventListener('touchmove', e => {
                e.preventDefault(); const d = startY - e.touches[0].clientY;
                const v = Math.min(1, Math.max(0, startVol + (d/300)));
                player.volume(v);
                showHud(`<i class="fas fa-volume-up"></i> ${Math.round(v*100)}%`);
            });
        }

        function showHud(html) {
            const hud = document.getElementById('gesture-feedback');
            hud.innerHTML = html; hud.style.display = 'block';
            clearTimeout(window.ht); window.ht = setTimeout(() => hud.style.display = 'none', 800);
        }

        function setupShortcuts() {
            document.addEventListener('keydown', e => {
                if(document.activeElement.tagName==='INPUT') return;
                if(e.key===' ') { e.preventDefault(); player.paused()?player.play():player.pause(); }
                if(e.key==='f') player.requestFullscreen();
            });
        }

        // Helpers
        function toggleFav(e, name) {
            e.stopPropagation();
            const idx = favorites.indexOf(name);
            if(idx > -1) { favorites.splice(idx, 1); showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù âŒ'); }
            else { favorites.push(name); showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© â¤ï¸'); }
            localStorage.setItem('ultimateFavs', JSON.stringify(favorites));
            if(document.querySelector('.cat-tag.special.active')) filterBy('fav', document.querySelector('.cat-tag.special'));
            else e.target.classList.toggle('active');
        }

        function filterBy(cat, btn) {
            document.querySelectorAll('.cat-tag').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (cat === 'all') renderChannels(allChannels);
            else if (cat === 'fav') renderChannels(allChannels.filter(c => favorites.includes(c.name)));
            else renderChannels(allChannels.filter(c => c.category === cat));
        }

        function handleSearch() {
            const q = document.getElementById('search-box').value.toLowerCase();
            renderChannels(allChannels.filter(c => c.name.toLowerCase().includes(q)));
        }

        function showToast(msg, long=false) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), long?5000:2000);
        }

        function shareChannel() {
            if(!currentChannel) return showToast("Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø©");
            const u = `${location.origin}${location.pathname}?ch=${encodeURIComponent(currentChannel.name)}`;
            navigator.clipboard.writeText(u).then(() => showToast("ØªÙ… Ø§Ù„Ù†Ø³Ø® ğŸ”—"));
        }
        
        async function togglePiP() {
            try { document.pictureInPictureElement?document.exitPictureInPicture():document.querySelector('video').requestPictureInPicture(); }
            catch(e){ showToast("PiP ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…"); }
        }

        function setSleepTimer() {
            const m = prompt("ÙƒÙ… Ø¯Ù‚ÙŠÙ‚Ø©ØŸ");
            if(m) { setTimeout(()=>player.pause(), m*60000); showToast(`Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø¹Ø¯ ${m} Ø¯Ù‚ÙŠÙ‚Ø©`); }
        }
    </script>
</body>
</html>

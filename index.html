<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hamza TV Max</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f0f0f">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HCNJRN7GQ6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-HCNJRN7GQ6');
    </script>

    <style>
        :root { --primary: #e50914; --bg: #0f0f0f; --card: #1f1f1f; --text: #fff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: 'Tajawal', sans-serif; margin: 0; padding-bottom: 100px; overflow-x: hidden; }

        /* Header Effect */
        header { position: sticky; top: 0; z-index: 50; padding: 15px; background: rgba(15,15,15,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #333; }
        .search-wrapper { position: relative; width: 100%; max-width: 600px; margin: 0 auto; }
        .search-inp { width: 100%; background: #222; border: none; padding: 12px 45px 12px 20px; border-radius: 50px; color: white; font-family: inherit; font-size: 16px; transition: 0.3s; }
        .search-inp:focus { background: #333; box-shadow: 0 0 0 2px var(--primary); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #777; }

        /* Categories Scroll */
        .cats { display: flex; gap: 10px; overflow-x: auto; padding: 15px; scrollbar-width: none; }
        .cats::-webkit-scrollbar { display: none; }
        .chip { background: #252525; padding: 8px 18px; border-radius: 20px; white-space: nowrap; font-size: 14px; cursor: pointer; transition: 0.3s; border: 1px solid transparent; color: #aaa; }
        .chip.active { background: var(--primary); color: white; font-weight: bold; border-color: var(--primary); box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4); }

        /* Continue Watching Section */
        .section-title { padding: 0 20px; font-weight: 800; font-size: 18px; margin-top: 10px; display: none; }
        .history-row { display: flex; gap: 15px; overflow-x: auto; padding: 15px 20px; scrollbar-width: none; display: none; }
        .history-card { min-width: 140px; height: 80px; background: linear-gradient(45deg, #222, #333); border-radius: 10px; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; border-left: 4px solid var(--primary); }
        .history-card span { font-size: 13px; font-weight: bold; padding: 5px; text-align: center; }

        /* Main Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 12px; padding: 15px; }
        .card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 130px; position: relative; transition: 0.3s; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); }
        .card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.1); border-color: var(--primary); }
        .card img { width: 55px; height: 55px; object-fit: contain; border-radius: 50%; background: #fff; padding: 4px; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .card h3 { font-size: 12px; text-align: center; margin: 0; color: #ddd; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .fav-btn { position: absolute; top: 8px; right: 8px; font-size: 18px; color: rgba(255,255,255,0.3); transition: 0.2s; z-index: 2; }
        .fav-btn.active { color: var(--primary); transform: scale(1.2); }

        /* Player Modal */
        .player-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 1000; display: none; flex-direction: column; justify-content: center; }
        video { width: 100%; max-height: 100vh; }
        .close-player { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2); color: white; padding: 8px 15px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; z-index: 1001; backdrop-filter: blur(5px); }

        /* Notifications */
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #333; color: white; padding: 12px 25px; border-radius: 30px; font-size: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: 0.4s; opacity: 0; z-index: 2000; display: flex; align-items: center; gap: 10px; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast-icon { color: var(--primary); font-size: 18px; }

        /* Loader */
        .loader { text-align: center; margin-top: 50px; color: #555; font-size: 14px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <header>
        <div class="search-wrapper">
            <span class="search-icon">ğŸ”</span>
            <input type="text" class="search-inp" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ù†Ø§Ø© (Ù…Ø«Ø§Ù„: Ø§Ù„Ø¬Ø²ÙŠØ±Ø©)..." onkeyup="filter()">
        </div>
    </header>

    <div class="section-title" id="hist-title">â±ï¸ ØªØ§Ø¨Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</div>
    <div class="history-row" id="history"></div>

    <div class="cats">
        <div class="chip active" onclick="setCat('all', this)">Ø§Ù„ÙƒÙ„</div>
        <div class="chip" onclick="setCat('fav', this)">â¤ï¸ Ø§Ù„Ù…ÙØ¶Ù„Ø©</div>
        <div class="chip" onclick="setCat('news', this)">ğŸ“° Ø£Ø®Ø¨Ø§Ø±</div>
        <div class="chip" onclick="setCat('movies', this)">ğŸ¬ Ø£ÙÙ„Ø§Ù…</div>
        <div class="chip" onclick="setCat('kids', this)">ğŸˆ Ø£Ø·ÙØ§Ù„</div>
        <div class="chip" onclick="setCat('sports', this)">âš½ Ø±ÙŠØ§Ø¶Ø©</div>
        <div class="chip" onclick="setCat('religious', this)">ğŸ•Œ Ø¥Ø³Ù„Ø§Ù…ÙŠ</div>
        <div class="chip" onclick="setCat('docu', this)">ğŸ¦ ÙˆØ«Ø§Ø¦Ù‚ÙŠ</div>
    </div>

    <div class="grid" id="grid"></div>
    <div class="loader" id="loader">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ù…Ø¦Ø§Øª Ø§Ù„Ù‚Ù†ÙˆØ§Øª... Ù„Ø­Ø¸Ø§Øª</div>

    <div class="player-modal" id="modal">
        <button class="close-player" onclick="closeVideo()">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
        <video id="video" controls playsinline></video>
    </div>

    <div class="toast" id="toast">
        <span class="toast-icon">âœ”</span> <span id="toast-msg">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</span>
    </div>

    <script>
        let allData = [];
        let favs = JSON.parse(localStorage.getItem('favs_v2')) || [];
        let history = JSON.parse(localStorage.getItem('history_v2')) || [];
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        fetch('channels.json?' + Date.now()).then(r => r.json()).then(d => {
            allData = d;
            document.getElementById('loader').style.display = 'none';
            renderHistory();
            render(allData);
        }).catch(() => {
            document.getElementById('loader').innerText = "âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±ÙˆØ¨ÙˆØª (Actions) Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©";
        });

        // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        function render(list) {
            const grid = document.getElementById('grid');
            grid.innerHTML = "";
            
            if(list.length === 0) {
                grid.innerHTML = "<p style='width:100%; text-align:center; color:#555'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>";
                return;
            }

            // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 100 Ù‚Ù†Ø§Ø© ÙÙ‚Ø· Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„ØµÙØ­Ø© (Lazy Render Ù…Ø¨Ø³Ø·)
            list.slice(0, 150).forEach(ch => {
                let isFav = favs.includes(ch.name);
                let logo = ch.logo || "https://cdn-icons-png.flaticon.com/512/2503/2503508.png";
                
                let el = document.createElement('div');
                el.className = 'card';
                el.innerHTML = `
                    <div class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFav('${ch.name}', event)">â™¥</div>
                    <img src="${logo}" loading="lazy" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2503/2503508.png'">
                    <h3>${ch.name}</h3>
                `;
                el.onclick = (e) => {
                    if(!e.target.classList.contains('fav-btn')) openVideo(ch);
                };
                grid.appendChild(el);
            });
        }

        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ®
        function renderHistory() {
            const row = document.getElementById('history');
            const title = document.getElementById('hist-title');
            
            if(history.length > 0) {
                row.style.display = 'flex';
                title.style.display = 'block';
                row.innerHTML = "";
                // Ù†Ø¹ÙƒØ³ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ¸Ù‡Ø± Ø¢Ø®Ø± Ù‚Ù†Ø§Ø© Ø¨Ø§Ù„Ø£ÙˆÙ„
                [...history].reverse().forEach(h => {
                    let div = document.createElement('div');
                    div.className = 'history-card';
                    div.innerHTML = `<span>${h.name}</span>`;
                    div.onclick = () => openVideo(h);
                    row.appendChild(div);
                });
            }
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„ØªØ§Ø±ÙŠØ®
        function openVideo(ch) {
            const modal = document.getElementById('modal');
            const video = document.getElementById('video');
            
            modal.style.display = 'flex';
            
            if (Hls.isSupported()) {
                let hls = new Hls();
                hls.loadSource(ch.url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = ch.url;
                video.play();
            }

            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªØ§Ø±ÙŠØ® (Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±)
            history = history.filter(x => x.name !== ch.name); // Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø§Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
            history.push({name: ch.name, url: ch.url});
            if(history.length > 10) history.shift(); // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 10 ÙÙ‚Ø·
            localStorage.setItem('history_v2', JSON.stringify(history));
            renderHistory();
        }

        function closeVideo() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('video').pause();
            document.getElementById('video').src = "";
        }

        // Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù…Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        function toggleFav(name, e) {
            e.stopPropagation();
            if(favs.includes(name)) {
                favs = favs.filter(n => n !== name);
                showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©");
            } else {
                favs.push(name);
                showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©");
            }
            localStorage.setItem('favs_v2', JSON.stringify(favs));
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ
            let active = document.querySelector('.chip.active').innerText;
            if(active.includes("Ø§Ù„Ù…ÙØ¶Ù„Ø©")) {
                setCat('fav', document.querySelector('.chip:nth-child(2)'));
            } else {
                // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙÙ‚Ø·
                let btn = e.target;
                btn.classList.toggle('active');
            }
        }

        // Ø§Ù„ÙÙ„ØªØ±
        function setCat(cat, btn) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            
            let res = [];
            if(cat === 'all') res = allData;
            else if(cat === 'fav') res = allData.filter(x => favs.includes(x.name));
            else res = allData.filter(x => x.category === cat);
            
            render(res);
        }

        function filter() {
            let q = document.getElementById('search').value.toLowerCase();
            let res = allData.filter(x => x.name.toLowerCase().includes(q));
            render(res);
        }

        // Ø¥Ø´Ø¹Ø§Ø± Ù…Ù†Ø¨Ø«Ù‚
        function showToast(txt) {
            let t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = txt;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
    </script>
</body>
</html>
